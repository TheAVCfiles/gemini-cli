<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rebuttal: Interactive Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-warm-bg { background-color: #fcfcf9; }
        .text-warm-text { color: #3d3a33; }
        .text-primary-700 { color: #0f766e; }
        .bg-primary-600 { background-color: #0d9488; }
        .hover\:bg-primary-700:hover { background-color: #0f766e; }
        .text-secondary-500 { color: #f59e0b; }
        .bg-secondary-500 { background-color: #f59e0b; }
        .hover\:bg-secondary-700:hover { background-color: #b45309; }
        .chart-container {
            position: relative;
            height: 100%;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                max-height: 500px;
            }
        }
        .gemini-btn-spinner {
            display: none;
            animation: spin 1s linear infinite;
        }
        .gemini-btn.loading .gemini-btn-spinner {
            display: inline-block;
        }
        .gemini-btn.loading .gemini-btn-text {
            display: none;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'warm-bg': '#fcfcf9',
                        'warm-text': '#3d3a33',
                        'primary': {
                            600: '#0d9488',
                            700: '#0f766e',
                        },
                        'secondary': {
                            500: '#f59e0b',
                            700: '#b45309',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-warm-bg text-warm-text antialiased">

    <!-- Header & Navigation -->
    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-sm shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="#" class="flex-shrink-0 flex items-center">
                    <span class="text-xl font-bold text-primary-700">Intuition Labs Rebuttal</span>
                </a>
                <nav class="hidden md:flex space-x-8">
                    <a href="#engine" class="text-sm font-medium text-gray-700 hover:text-primary-700 transition-colors">Pillar 1: Engine & Proof</a>
                    <a href="#logic" class="text-sm font-medium text-gray-700 hover:text-primary-700 transition-colors">Pillar 2: Logic & Intuition</a>
                    <a href="#ecosystem" class="text-sm font-medium text-gray-700 hover:text-primary-700 transition-colors">Pillar 3: Ecosystem & Trust</a>
                </nav>
                <div class="md:hidden">
                    <button id="mobile-menu-btn" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-500">
                        <span class="sr-only">Open main menu</span>
                        <div class="space-y-1.5">
                            <span id="burger-top" class="block h-0.5 w-6 bg-primary-700 transition duration-300 ease-in-out"></span>
                            <span id="burger-mid" class="block h-0.5 w-6 bg-primary-700 transition duration-300 ease-in-out"></span>
                            <span id="burger-bot" class="block h-0.5 w-6 bg-primary-700 transition duration-300 ease-in-out"></span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 flex flex-col">
                <a href="#engine" class="text-base font-medium text-gray-700 hover:text-primary-700 hover:bg-gray-50 px-3 py-2 rounded-md transition-colors">Pillar 1: Engine & Proof</a>
                <a href="#logic" class="text-base font-medium text-gray-700 hover:text-primary-700 hover:bg-gray-50 px-3 py-2 rounded-md transition-colors">Pillar 2: Logic & Intuition</a>
                <a href="#ecosystem" class="text-base font-medium text-gray-700 hover:text-primary-700 hover:bg-gray-50 px-3 py-2 rounded-md transition-colors">Pillar 3: Ecosystem & Trust</a>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="py-16 sm:py-20">
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-center text-warm-text tracking-tight">
                The Adaptive Ethics Rebuttal
            </h1>
            <p class="mt-6 text-xl text-gray-700 text-center max-w-3xl mx-auto">
                This is an interactive exploration of the rebuttal against critiques of the Intuition Labs system. We've transformed the six-part document into three dynamic pillars to demonstrate how our platform is data-validated, auditable, and community-governed.
            </p>
        </div>

        <section id="engine" class="py-16 sm:py-20 border-t border-gray-200">
            <h2 class="text-3xl sm:text-4xl font-bold text-primary-700 mb-4">Pillar 1: The Core Engine & Proof</h2>
            
            <div id="engine-intro-container" class="flex items-center gap-4 mb-8">
                <p class="text-lg text-gray-700 max-w-3xl">
                    This section addresses the critique that our system lacks external proof. Here, we combine the claims from "Quantitative Proof" (Sec I) and the "Cunning Mercy Protocol" (Sec III) to show how statistical rigor and risk management are hard-coded into the engine's core. Interact with the snapshot below to see how data *directly* controls risk.
                </p>
                <button id="listen-engine-btn" class="gemini-btn flex-shrink-0 bg-secondary-500 text-white px-3 py-2 rounded-full font-medium shadow-md hover:bg-secondary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-secondary-500 focus:ring-opacity-50" title="Listen to intro">
                    <span class="gemini-btn-text">Listen ‚ú®</span>
                    <span class="gemini-btn-spinner text-lg">&#8635;</span>
                </button>
            </div>

            <button id="summarize-engine-btn" class="gemini-btn mb-6 bg-primary-600 text-white px-4 py-2 rounded-lg font-medium shadow-md hover:bg-primary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50">
                <span class="gemini-btn-text">‚ú® Summarize Pillar with Gemini</span>
                <span class="gemini-btn-spinner text-xl">&#8635;</span>
            </button>
            
            <div id="engine-summary-container" class="mb-12 p-4 rounded-lg bg-primary-600/10 text-warm-text hidden transition-all duration-300">
                <h4 class="text-lg font-semibold text-primary-700 mb-2">‚ú® AI Summary</h4>
                <div id="engine-summary-content"></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                <div class="lg:col-span-1 bg-white rounded-xl shadow-xl overflow-hidden p-6 border border-gray-100">
                    <h3 class="text-2xl font-semibold text-primary-700 mb-4 border-b pb-2">Risk/Proof Snapshot</h3>
                    
                    <div class="space-y-4">
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm font-medium text-gray-500">Current Tau Score (Correlation)</p>
                            <p id="metric-tau" class="text-2xl font-bold text-warm-text">N/A</p>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm font-medium text-gray-500">P-Value (Significance)</p>
                            <p id="metric-pvalue" class="text-2xl font-bold text-warm-text">N/A</p>
                        </div>
                        <div class="p-3 rounded-lg border-2" id="mercy-gate">
                            <p class="text-sm font-medium text-gray-500">Cunning Mercy Gate (P &le; 0.05)</p>
                            <p id="gate-3" class="text-xl font-bold text-red-500">CLOSED üö´</p>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <p class="text-sm font-medium text-gray-500 mb-2">Protocol Outcome</p>
                        <div id="mercy-outcome" class="mt-2 p-4 rounded-lg bg-gray-100 text-center transition-all duration-300 border border-gray-200">
                            <p class="text-lg font-semibold text-warm-text">Status: Awaiting Simulation</p>
                        </div>
                    </div>

                    <div class="mt-8 space-y-3">
                        <button id="simulate-safe-btn" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold shadow-md hover:bg-green-700 transition-colors">
                            Simulate: High-Confidence Data
                        </button>
                        <button id="simulate-risky-btn" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold shadow-md hover:bg-red-700 transition-colors">
                            Simulate: Low-Confidence Data
                        </button>
                        <button id="simulate-reset-btn" class="w-full bg-gray-300 text-warm-text py-2 rounded-lg font-semibold shadow-md hover:bg-gray-400 transition-colors">
                            Reset
                        </button>
                    </div>
                </div>
                
                <div class="lg:col-span-2 bg-white rounded-xl shadow-xl overflow-hidden p-6 border border-gray-100">
                    <h3 class="text-2xl font-semibold text-primary-700 mb-4 border-b pb-2">Backtest Performance Chart</h3>
                    <div class="chart-container">
                        <canvas id="backtestChart"></canvas>
                    </div>
                    <p class="mt-4 text-sm text-gray-500">
                        *This chart visually represents the strong correlation (Tau > 0.6) between the engine's signal and market outcome over a simulated 180-day period using historical data, refuting claims of statistical irrelevance.
                    </p>
                </div>
            </div>

        </section>

        <section id="logic" class="py-16 sm:py-20 border-t border-gray-200">
            <h2 class="text-3xl sm:text-4xl font-bold text-primary-700 mb-4">Pillar 2: Logic & Intuition</h2>
            
            <div id="logic-intro-container" class="flex items-center gap-4 mb-8">
                <p class="text-lg text-gray-700 max-w-3xl">
                    This pillar refutes the "N=1" (founder-dependent) and "black box" critiques. It combines "Beyond N=1" (Sec II) and "Dual-Layer Design" (Sec IV) to show how kinesthetic intuition is translated into scalable, auditable code. Explore the "translation" from poetic terms to the logic layer below.
                </p>
                <button id="listen-logic-btn" class="gemini-btn flex-shrink-0 bg-secondary-500 text-white px-3 py-2 rounded-full font-medium shadow-md hover:bg-secondary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-secondary-500 focus:ring-opacity-50" title="Listen to intro">
                    <span class="gemini-btn-text">Listen ‚ú®</span>
                    <span class="gemini-btn-spinner text-lg">&#8635;</span>
                </button>
            </div>

            <button id="summarize-logic-btn" class="gemini-btn mb-6 bg-primary-600 text-white px-4 py-2 rounded-lg font-medium shadow-md hover:bg-primary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50">
                <span class="gemini-btn-text">‚ú® Summarize Pillar with Gemini</span>
                <span class="gemini-btn-spinner text-xl">&#8635;</span>
            </button>
            
            <div id="logic-summary-container" class="mb-12 p-4 rounded-lg bg-primary-600/10 text-warm-text hidden transition-all duration-300">
                <h4 class="text-lg font-semibold text-primary-700 mb-2">‚ú® AI Summary</h4>
                <div id="logic-summary-content"></div>
            </div>

            <div class="bg-white rounded-xl shadow-xl overflow-hidden p-6 border border-gray-100 mb-12">
                <h3 class="text-2xl font-semibold text-primary-700 mb-4 border-b pb-2">Dual-Layer FSM (Finite State Machine)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="text-sm font-medium text-gray-500">Kinesthetic Layer (Poetic State)</p>
                        <p id="fsm-poetic" class="text-xl font-bold text-warm-text mt-1">Stasis (Neutral)</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="text-sm font-medium text-gray-500">Logic Layer (FSM State)</p>
                        <p id="fsm-logic" class="text-xl font-bold text-warm-text mt-1">STATE_IDLE</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="text-sm font-medium text-gray-500">Next Signal/Cue</p>
                        <p id="fsm-signal" class="text-xl font-bold text-warm-text mt-1">CUE: None</p>
                    </div>
                </div>

                <div class="mt-6 flex flex-wrap gap-3 justify-center">
                    <button data-state="Coda" class="fsm-btn bg-green-500 text-white px-4 py-2 rounded-full font-medium shadow-md hover:bg-green-600 transition-colors">Coda (Profit)</button>
                    <button data-state="Lull" class="fsm-btn bg-blue-500 text-white px-4 py-2 rounded-full font-medium shadow-md hover:bg-blue-600 transition-colors">Lull (Wait)</button>
                    <button data-state="Amnesty" class="fsm-btn bg-yellow-500 text-gray-800 px-4 py-2 rounded-full font-medium shadow-md hover:bg-yellow-600 transition-colors">Amnesty (Risk Off)</button>
                    <button data-state="Flint" class="fsm-btn bg-red-500 text-white px-4 py-2 rounded-full font-medium shadow-md hover:bg-red-600 transition-colors">Flint (Risk On)</button>
                </div>
                
                <button id="generate-code-btn" class="gemini-btn mt-6 w-full bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                    <span class="gemini-btn-text">‚ú® Generate Logic Code for Current State</span>
                    <span class="gemini-btn-spinner text-xl">&#8635;</span>
                </button>

                <div id="code-output-container" class="mt-6 p-4 rounded-lg bg-gray-800 text-gray-50 hidden transition-all duration-300">
                    <h4 class="text-lg font-semibold text-indigo-400 mb-2">‚ú® Auditable Python Logic</h4>
                    <pre id="code-output" class="text-sm overflow-x-auto font-mono p-2 bg-black rounded"></pre>
                </div>
                
                <div class="mt-8 p-4 bg-gray-100 rounded-lg border border-gray-200">
                    <p class="text-sm font-medium text-gray-500 mb-2">FSM Output Log</p>
                    <pre id="fsm-output-log" class="text-sm text-warm-text whitespace-pre-wrap font-mono"></pre>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-xl overflow-hidden p-6 border border-gray-100">
                <h3 class="text-2xl font-semibold text-primary-700 mb-4 border-b pb-2">Auditable Logic Mapping</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kinesthetic Term</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Logic Layer Translation</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Audit Condition</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <tr class="bg-gray-50">
                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-warm-text">Stasis</td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">STATE_IDLE</td>
                                <td id="condition-stasis" class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">`time_in_state > 30s` AND `momentum_idx = 0`</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-warm-text">Flint (Risk On)</td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">STATE_ENTRY</td>
                                <td id="condition-flint" class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">`sentiment_score < -0.8` AND `volume_spike > 2x`</td>
                            </tr>
                            <tr class="bg-gray-50">
                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-warm-text">Amnesty (Risk Off)</td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">STATE_EXIT</td>
                                <td id="condition-amnesty" class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">`mercy_gate = CLOSED` OR `vix_delta > 1.5`</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-warm-text">Coda (Profit)</td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">STATE_EXIT</td>
                                <td id="condition-coda" class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">`target_angle_45_hit = true`</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="ecosystem" class="py-16 sm:py-20 border-t border-gray-200">
            <h2 class="text-3xl sm:text-4xl font-bold text-primary-700 mb-4">Pillar 3: Ecosystem & Trust</h2>
            
            <div id="ecosystem-intro-container" class="flex items-center gap-4 mb-8">
                <p class="text-lg text-gray-700 max-w-3xl">
                    This final pillar addresses the system's future, combining the "Roadmap" (Sec V) and "Institutionalization" (Sec VI). We are building an open, auditable ecosystem, not a personal project. Our governance is built on verifiable reputation ("Sentient Cents"), not speculation, ensuring the founder's vision is institutionalized.
                </p>
                <button id="listen-ecosystem-btn" class="gemini-btn flex-shrink-0 bg-secondary-500 text-white px-3 py-2 rounded-full font-medium shadow-md hover:bg-secondary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-secondary-500 focus:ring-opacity-50" title="Listen to intro">
                    <span class="gemini-btn-text">Listen ‚ú®</span>
                    <span class="gemini-btn-spinner text-lg">&#8635;</span>
                </button>
            </div>
            
            <button id="summarize-ecosystem-btn" class="gemini-btn mb-6 bg-primary-600 text-white px-4 py-2 rounded-lg font-medium shadow-md hover:bg-primary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50">
                <span class="gemini-btn-text">‚ú® Summarize Pillar with Gemini</span>
                <span class="gemini-btn-spinner text-xl">&#8635;</span>
            </button>
            
            <div id="ecosystem-summary-container" class="mb-12 p-4 rounded-lg bg-primary-600/10 text-warm-text hidden transition-all duration-300">
                <h4 class="text-lg font-semibold text-primary-700 mb-2">‚ú® AI Summary</h4>
                <div id="ecosystem-summary-content"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-stretch">
                <div class="bg-white rounded-xl shadow-xl overflow-hidden p-6 border border-gray-100">
                    <h3 class="text-2xl font-semibold text-primary-700 mb-4 border-b pb-2">Decentralized Governance Roadmap</h3>
                    <ul class="space-y-4 list-disc list-inside text-gray-700">
                        <li class="pl-2">
                            <span class="font-semibold text-warm-text">Phase 1 (Q4/24):</span> Core Protocol Open-Sourcing. Move all non-proprietary logic to public repositories for community auditing.
                        </li>
                        <li class="pl-2">
                            <span class="font-semibold text-warm-text">Phase 2 (Q1/25):</span> Introduction of Sentient Cents (SC). Reputation-based, non-transferable soulbound tokens (SBTs) granted based on validated contributions.
                        </li>
                        <li class="pl-2">
                            <span class="font-semibold text-warm-text">Phase 3 (Q2/25):</span> Decentralized Autonomous Organization (DAO) Formation. Governance weighted by SC stake, ensuring decision-making power rests with proven contributors.
                        </li>
                        <li class="pl-2">
                            <span class="font-semibold text-warm-text">Phase 4 (Q3/25):</span> Adaptive Protocol Veto. Community-led votes on protocol changes, requiring 75% SC consensus.
                        </li>
                    </ul>
                </div>
                
                <div class="bg-white rounded-xl shadow-xl overflow-hidden p-6 border border-gray-100">
                    <h3 class="text-2xl font-semibold text-primary-700 mb-4 border-b pb-2">Ecosystem Architecture</h3>
                    <div class="flex flex-col items-center justify-center space-y-4 h-full min-h-[300px]">
                        <div class="p-4 bg-primary-600 text-white rounded-full shadow-lg font-bold">
                            Adaptive Ethics Foundation üõ°Ô∏è
                        </div>
                        <div class="text-xl text-primary-700">|</div>
                        <div class="flex space-x-8">
                            <div class="flex flex-col items-center p-4 bg-gray-100 rounded-xl shadow-md border border-gray-200">
                                <span class="text-3xl mb-2">üë•</span>
                                <span class="font-medium text-warm-text">DAO & Community</span>
                                <span class="text-xs text-gray-500">Governance & Auditing</span>
                            </div>
                            <div class="flex flex-col items-center p-4 bg-gray-100 rounded-xl shadow-md border border-gray-200">
                                <span class="text-3xl mb-2">üéñÔ∏è</span>
                                <span class="font-medium text-warm-text">Sentient Cents (SC)</span>
                                <span class="text-xs text-gray-500">Reputation & Stake</span>
                            </div>
                        </div>
                        <div class="text-xl text-primary-700">|</div>
                        <div class="p-3 bg-secondary-500 text-white rounded-lg shadow-lg font-bold">
                            Intuition Labs Protocol Core
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-16 sm:py-20 border-t border-gray-200">
            <h2 class="text-3xl sm:text-4xl font-bold text-center text-primary-700 mb-4">Conclusion</h2>
            <p class="mt-6 text-lg text-gray-700 max-w-4xl mx-auto text-center">
                The critique that Intuition Labs is a "black box" dependent on a single founder is demonstrably false. Our system is quantitatively proven via statistical correlation, auditable through our Dual-Layer FSM, and engineered for institutionalization under a merit-based, decentralized governance model. The next steps involve transitioning to a fully open-source and SC-governed structure.
            </p>
        </section>
    </main>

    <footer class="bg-white border-t border-gray-200 mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center">
            <p class="text-sm text-gray-500">&copy; 2025 Adaptive Ethics Foundation & Intuition Labs. All rights reserved.</p>
        </div>
    </footer>

    <audio id="tts-player" class="hidden"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const API_KEY = ""; 

            const audioPlayer = document.getElementById('tts-player');
            let currentPlayingBtn = null;
            
            const generateCodeBtn = document.getElementById('generate-code-btn');
            const codeOutputContainer = document.getElementById('code-output-container');
            const codeOutput = document.getElementById('code-output');

            const codeConditionsMap = {
                'Stasis': {
                    condition: document.getElementById('condition-stasis').textContent.trim(),
                    logic: 'Check if the system has been idle for more than 30 seconds (time_in_state) and momentum index (momentum_idx) is zero.'
                },
                'Flint': {
                    condition: document.getElementById('condition-flint').textContent.trim(),
                    logic: 'Check if sentiment score (sentiment_score) is less than -0.8 AND volume spike (volume_spike) is more than double the average (2x).'
                },
                'Amnesty': {
                    condition: document.getElementById('condition-amnesty').textContent.trim(),
                    logic: 'Check if the Cunning Mercy Gate (mercy_gate) is closed OR the volatility index change (vix_delta) is greater than 1.5.'
                },
                'Coda': {
                    condition: document.getElementById('condition-coda').textContent.trim(),
                    logic: 'Check if the predefined profit target (target_angle_45_hit) has been successfully achieved (true).'
                },
                'Lull': {
                     condition: 'time_since_last_signal > 60s AND market_volatility < 0.2',
                     logic: 'Check if more than 60 seconds have passed since the last signal AND market volatility is below the 0.2 threshold.'
                }
            };

            const ttsButtons = [
                { id: 'listen-engine-btn', textId: 'engine-intro-container' },
                { id: 'listen-logic-btn', textId: 'logic-intro-container' },
                { id: 'listen-ecosystem-btn', textId: 'ecosystem-intro-container' },
            ];

            const summaryButtons = [
                { id: 'summarize-engine-btn', sectionId: 'engine', contentId: 'engine-summary-content', containerId: 'engine-summary-container' },
                { id: 'summarize-logic-btn', sectionId: 'logic', contentId: 'logic-summary-content', containerId: 'logic-summary-container' },
                { id: 'summarize-ecosystem-btn', sectionId: 'ecosystem', contentId: 'ecosystem-summary-content', containerId: 'ecosystem-summary-container' },
            ];

            const geminiSystemPromptSummary = "You are an expert analyst. Summarize the following information from a technical rebuttal into a concise HTML list with 3 bullet points (<ul><li>...</li></ul>). Focus on the core claims, evidence, and strategic implications. Do not include any introductory or concluding sentences outside the list.";
            const geminiSystemPromptCode = "You are a specialized code generation assistant. Only output the Python code inside a single ```python block, fully commented and runnable, with no conversational text or markdown outside the code block. Use clear, modern Python.";


            async function callGeminiAPI(userPrompt, systemPrompt, retries = 3, delay = 1000) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
                
                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            return candidate.content.parts[0].text;
                        } else {
                            throw new Error("Invalid API response structure or empty content.");
                        }
                    } catch (error) {
                        if (i === retries - 1) {
                            console.error("Gemini API call failed after retries:", error);
                            if (systemPrompt === geminiSystemPromptCode) {
                                return "```python\n# Error: Could not generate code snippet. Please try again. (" + error.message + ")\n```";
                            }
                            return `<p class="text-red-600">Error: Could not generate summary. Please try again. (${error.message})</p>`;
                        }
                        await new Promise(res => setTimeout(res, delay * (i + 1)));
                    }
                }
            }
            
            async function callGeminiTTSAPI(textToSpeak, voiceName = "Charon", retries = 3, delay = 1000) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
                
                const payload = {
                    contents: [{
                        parts: [{ text: `Say informatively: ${textToSpeak}` }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: voiceName }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        const part = result?.candidates?.[0]?.content?.parts?.[0];
                        const audioData = part?.inlineData?.data;
                        const mimeType = part?.inlineData?.mimeType;

                        if (audioData && mimeType && mimeType.startsWith("audio/")) {
                            return { audioData, mimeType };
                        } else {
                            throw new Error("Invalid TTS API response structure or missing audio data.");
                        }
                    } catch (error) {
                        if (i === retries - 1) {
                            console.error("Gemini TTS API call failed after retries:", error);
                            return null;
                        }
                        await new Promise(res => setTimeout(res, delay * (i + 1)));
                    }
                }
            }

            function base64ToArrayBuffer(base64) {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            }

            function pcmToWav(pcmData, sampleRate) {
                const numChannels = 1;
                const bitsPerSample = 16;
                const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
                const blockAlign = numChannels * (bitsPerSample / 8);
                const dataSize = pcmData.length * (bitsPerSample / 8);
                const wavSize = 36 + dataSize;
                
                const buffer = new ArrayBuffer(wavSize + 8);
                const view = new DataView(buffer);

                view.setUint32(0, 0x52494646, false); 
                view.setUint32(4, wavSize, true); 
                view.setUint32(8, 0x57415645, false); 
                view.setUint32(12, 0x666D7420, false); 
                view.setUint32(16, 16, true); 
                view.setUint32(20, 1, true); 
                view.setUint32(22, numChannels, true); 
                view.setUint32(24, sampleRate, true); 
                view.setUint32(28, byteRate, true); 
                view.setUint32(32, blockAlign, true); 
                view.setUint32(34, bitsPerSample, true); 
                view.setUint32(36, 0x64617461, false); 
                view.setUint32(40, dataSize, true); 

                const pcm16 = new Int16Array(pcmData.buffer);
                const pcmView = new DataView(pcm16.buffer);
                for (let i = 0; i < pcm16.length; i++) {
                    view.setInt16(44 + i * 2, pcmView.getInt16(i * 2, true), true);
                }

                return new Blob([buffer], { type: 'audio/wav' });
            }

            async function playAudioData(apiResponse, btn) {
                if (!apiResponse) {
                    alert("Error generating audio.");
                    resetTtsButton(btn);
                    return;
                }

                try {
                    const sampleRateMatch = apiResponse.mimeType.match(/rate=(\d+)/);
                    if (!sampleRateMatch) {
                        throw new Error("Could not parse sample rate from mime type.");
                    }
                    const sampleRate = parseInt(sampleRateMatch[1], 10);
                    const pcmData = base64ToArrayBuffer(apiResponse.audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    audioPlayer.src = audioUrl;
                    
                    audioPlayer.play();
                    
                    btn.querySelector('.gemini-btn-text').textContent = "Playing...";
                    currentPlayingBtn = btn;

                    audioPlayer.onended = () => {
                        resetTtsButton(currentPlayingBtn);
                        currentPlayingBtn = null;
                        URL.revokeObjectURL(audioUrl);
                    };
                } catch (error) {
                    console.error("Error processing audio:", error);
                    alert("Error playing audio.");
                    resetTtsButton(btn);
                }
            }

            function resetTtsButton(btn) {
                if (btn) {
                    btn.classList.remove('loading');
                    btn.querySelector('.gemini-btn-text').textContent = "Listen ‚ú®";
                    btn.disabled = false;
                }
            }

            ttsButtons.forEach(item => {
                const btn = document.getElementById(item.id);
                btn.addEventListener('click', async () => {
                    if (currentPlayingBtn) {
                        audioPlayer.pause();
                        audioPlayer.currentTime = 0;
                        resetTtsButton(currentPlayingBtn);
                        if (currentPlayingBtn === btn) {
                            currentPlayingBtn = null;
                            return; 
                        }
                    }

                    audioPlayer.play().catch(e => {});
                    audioPlayer.pause();
                    audioPlayer.currentTime = 0;
                    
                    btn.classList.add('loading');
                    btn.disabled = true;

                    const textContainer = document.getElementById(item.textId);
                    const textToSpeak = textContainer.querySelector('p').textContent.trim();
                    
                    if (!textToSpeak) {
                        alert("Error: Could not find text to speak.");
                        resetTtsButton(btn);
                        return;
                    }
                    
                    const audioData = await callGeminiTTSAPI(textToSpeak);
                    if (audioData) {
                        await playAudioData(audioData, btn);
                    } else {
                        resetTtsButton(btn);
                    }
                });
            });

            summaryButtons.forEach(item => {
                const btn = document.getElementById(item.id);
                btn.addEventListener('click', async () => {
                    btn.classList.add('loading');
                    btn.disabled = true;

                    const section = document.getElementById(item.sectionId);
                    const contentContainer = document.getElementById(item.contentId);
                    const summaryContainer = document.getElementById(item.containerId);
                    
                    const sectionText = section.textContent.trim();
                    const summaryHtml = await callGeminiAPI(sectionText, geminiSystemPromptSummary);
                    
                    contentContainer.innerHTML = summaryHtml;
                    summaryContainer.classList.remove('hidden');

                    btn.classList.remove('loading');
                    btn.disabled = false;
                });
            });

            generateCodeBtn.addEventListener('click', async () => {
                const currentStateText = document.getElementById('fsm-poetic').textContent.trim();
                const currentStateName = currentStateText.split(' ')[0];
                const condition = codeConditionsMap[currentStateName];
            
                if (!condition) {
                    codeOutput.textContent = "# Error: Please interact with the FSM buttons (Coda, Lull, Amnesty, Flint) above to select a state before generating code.";
                    codeOutputContainer.classList.remove('hidden');
                    return;
                }
            
                generateCodeBtn.classList.add('loading');
                generateCodeBtn.disabled = true;
                
                const userPrompt = `Generate a runnable Python function named \`check_condition\` that implements the core logic for the state '${currentStateName}'. The logic is: "${condition.logic}". The precise condition based on the table is: "${condition.condition}". The function should take a single dictionary argument named \`data\` containing relevant key-value pairs (e.g., 'sentiment_score', 'volume_spike', etc.). Include a docstring and example usage demonstrating the function works for both true and false outcomes.`;
            
                let codeSnippet = await callGeminiAPI(userPrompt, geminiSystemPromptCode, 3, 1500);
                
                const match = codeSnippet.match(/```python\s*([\s\S]*?)\s*```/);
                if (match && match[1]) {
                    codeOutput.textContent = match[1].trim();
                } else {
                    codeOutput.textContent = codeSnippet.trim();
                }
            
                codeOutputContainer.classList.remove('hidden');
            
                generateCodeBtn.classList.remove('loading');
                generateCodeBtn.disabled = false;
            });


            const initialState = {
                tauScore: 'N/A',
                pValue: 'N/A',
                mercyGateOpen: false,
                outcome: 'Awaiting Simulation',
                outcomeClass: 'bg-gray-100',
                pValueNum: null
            };
            
            const safeState = {
                tauScore: '0.71',
                pValue: '0.021',
                mercyGateOpen: true,
                outcome: 'Gate OPEN. Protocol is active, risk accepted.',
                outcomeClass: 'bg-green-100',
                pValueNum: 0.021
            };
            
            const riskyState = {
                tauScore: '0.33',
                pValue: '0.330',
                mercyGateOpen: false,
                outcome: 'Gate CLOSED. Protocol stopped, risk denied.',
                outcomeClass: 'bg-red-100',
                pValueNum: 0.330
            };
            
            let currentState = { ...initialState };
            
            const metricTau = document.getElementById('metric-tau');
            const metricPValue = document.getElementById('metric-pvalue');
            
            const mercyGate = document.getElementById('mercy-gate');
            const gate3 = document.getElementById('gate-3');
            const mercyOutcome = document.getElementById('mercy-outcome');
            
            const simulateSafeBtn = document.getElementById('simulate-safe-btn');
            const simulateRiskyBtn = document.getElementById('simulate-risky-btn');
            const simulateResetBtn = document.getElementById('simulate-reset-btn');

            function updateDisplay() {
                metricTau.textContent = currentState.tauScore;
                metricPValue.textContent = currentState.pValue;
                
                gate3.textContent = currentState.mercyGateOpen ? 'OPEN ‚úÖ' : 'CLOSED üö´';
                mercyGate.classList.toggle('border-green-500', currentState.mercyGateOpen);
                mercyGate.classList.toggle('border-red-500', !currentState.mercyGateOpen && currentState.pValueNum !== null);
                gate3.classList.toggle('text-green-500', currentState.mercyGateOpen);
                gate3.classList.toggle('text-red-500', !currentState.mercyGateOpen && currentState.pValueNum !== null);
                
                mercyOutcome.textContent = currentState.outcome;
                mercyOutcome.className = `mt-2 p-4 rounded-lg text-center transition-all duration-300 border ${currentState.outcomeClass}`;
                
                if (currentState.mercyGateOpen) {
                    mercyOutcome.className = 'mt-6 p-4 rounded-lg bg-green-50 text-center transition-all duration-300 border border-green-200';
                } else if (currentState.pValueNum !== null) {
                    mercyOutcome.className = 'mt-6 p-4 rounded-lg bg-red-50 text-center transition-all duration-300 border border-red-200';
                } else {
                    mercyOutcome.className = 'mt-6 p-4 rounded-lg bg-gray-100 text-center transition-all duration-300 border border-gray-200';
                }
            }

            simulateSafeBtn.addEventListener('click', () => {
                currentState = { ...safeState };
                updateDisplay();
            });

            simulateRiskyBtn.addEventListener('click', () => {
                currentState = { ...riskyState };
                updateDisplay();
            });

            simulateResetBtn.addEventListener('click', () => {
                currentState = { ...initialState };
                updateDisplay();
            });

            const fsmBtns = document.querySelectorAll('.fsm-btn');
            const fsmPoetic = document.getElementById('fsm-poetic');
            const fsmLogic = document.getElementById('fsm-logic');
            const fsmSignal = document.getElementById('fsm-signal');
            const fsmOutputLog = document.getElementById('fsm-output-log');

            const fsmData = {
                'Stasis': { logic: 'STATE_IDLE', signal: 'CUE: None', log: '[10:00] FSM: Initialized to STATE_IDLE. Awaiting signal.' },
                'Coda': { 
                    logic: 'STATE_EXIT', 
                    signal: 'CUE: Coda (Profit)',
                    log: '[10:15] CUE: Coda (Profit) | Target Angle45 hit. Exiting position with profit.'
                },
                'Lull': { 
                    logic: 'STATE_WAIT', 
                    signal: 'CUE: Lull (Wait)', 
                    log: '[10:05] CUE: Lull (Wait) | Volatility dropped below threshold. Entering STATE_WAIT.'
                },
                'Amnesty': { 
                    logic: 'STATE_EXIT', 
                    signal: 'CUE: Amnesty (Risk Off)', 
                    log: '[10:20] CUE: Amnesty (Risk Off) | Mercy Gate CLOSED. Immediate risk denial initiated.'
                },
                'Flint': { 
                    logic: 'STATE_ENTRY', 
                    signal: 'CUE: Flint (Risk On)', 
                    log: '[10:10] CUE: Flint (Risk On) | Sentiment score -0.9, volume spike confirmed. Entering position.'
                }
            };

            fsmBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const stateName = btn.getAttribute('data-state');
                    const data = fsmData[stateName];
                    
                    if (data) {
                        fsmPoetic.textContent = `${stateName} (${data.signal.split(': ')[1].split(')')[0]})`;
                        fsmLogic.textContent = data.logic;
                        fsmSignal.textContent = data.signal;
                        fsmOutputLog.textContent = data.log;
                    }
                });
            });

            const backtestCtx = document.getElementById('backtestChart').getContext('2d');
            new Chart(backtestCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 180}, (_, i) => `Day ${i+1}`),
                    datasets: [
                        {
                            label: 'Engine Signal Strength (Normalized)',
                            data: Array.from({length: 180}, (_, i) => Math.sin(i / 10) * 0.4 + Math.random() * 0.2 + 0.4),
                            borderColor: '#0d9488', 
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Market Outcome (Cumulative %)',
                            data: Array.from({length: 180}, (_, i) => (i / 180) * 10 + Math.random() * 3 - 1.5),
                            borderColor: '#f59e0b', 
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Signal Strength (0-1)'
                            },
                            min: 0,
                            max: 1
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Market Outcome (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });

            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            const burgerTop = document.getElementById('burger-top');
            const burgerMid = document.getElementById('burger-mid');
            const burgerBot = document.getElementById('burger-bot');
            
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                burgerTop.classList.toggle('rotate-45');
                burgerTop.classList.toggle('translate-y-2');
                burgerMid.classList.toggle('opacity-0');
                burgerBot.classList.toggle('-translate-y-2');
                burgerBot.classList.toggle('-rotate-45');
            });
            
            document.querySelectorAll('#mobile-menu a').forEach(link => {
                link.addEventListener('click', () => {
                    mobileMenu.classList.add('hidden');
                    burgerTop.classList.remove('rotate-45', 'translate-y-2');
                    burgerMid.classList.remove('opacity-0');
                    burgerBot.classList.remove('-translate-y-2', '-rotate-45');
                });
            });

            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelector(this.getAttribute('href')).scrollIntoView({
                        behavior: 'smooth'
                    });
                });
            });

            updateDisplay();
        });
    </script>
</body>
</html>
