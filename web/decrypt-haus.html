<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Decrypt Haus · Grid Access</title>
<style>
  :root { --bg:#0b0b0c; --fg:#f5f5f7; --muted:#a8a8ad; --acc:#ff3366; --card:#121214; }
  body { margin:0; background:var(--bg); color:var(--fg); font-family: -apple-system, Inter, system-ui, Arial; }
  .wrap { max-width:640px; margin:0 auto; padding:24px; }
  .card { background:var(--card); border-radius:16px; padding:20px; box-shadow:0 6px 28px rgba(0,0,0,.35); }
  h1 { font-size:22px; margin:0 0 12px; }
  label { display:block; font-size:14px; color:var(--muted); margin-top:14px; }
  input[type="text"], input[type="file"] { width:100%; padding:12px; border-radius:10px; border:1px solid #242428; background:#16161a; color:var(--fg); }
  .row { display:flex; gap:10px; }
  button { background:var(--acc); border:0; color:white; font-weight:600; padding:12px 16px; border-radius:10px; cursor:pointer; }
  .btn-ghost { background:transparent; border:1px solid #2a2a2f; color:var(--fg); }
  pre { background:#0e0e11; border-radius:10px; padding:12px; overflow:auto; max-height:280px; }
  .ok { color:#80ffb4; }
  .warn { color:#ffd166; }
  .ring { height:220px; width:220px; border-radius:50%; background:
    radial-gradient(circle at 50% 50%, rgba(255,51,102,.12), transparent 60%),
    conic-gradient(from var(--angle,0deg), #6ca8ff, #9ec5ff, #e6f1ff, #6ca8ff); 
    filter: blur(.2px) saturate(110%); margin: 18px auto;
    display:flex; align-items:center; justify-content:center; position:relative; }
  .ring:after{ content:""; height:140px; width:140px; border-radius:50%;
    background: radial-gradient(circle at 50% 50%, rgba(255,51,102,.15), transparent 60%),
    conic-gradient(from calc(var(--angle,0deg) * -1), #9ec5ff, #e6f1ff, #6ca8ff, #9ec5ff);
    mix-blend: screen; opacity:.6;
  }
  .dot { position:absolute; height:10px; width:10px; border-radius:50%; background:white; 
    top:10px; left:50%; transform:translateX(-50%); box-shadow:0 0 12px rgba(255,255,255,.7)}
  small { color:var(--muted); }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Grid Access · Elite ZIP Credential</h1>
    <small>Soft proof or ownership → issued as a verifiable credential. Clinical bones, poetic lungs.</small>

    <label>ZIP Code</label>
    <input id="zip" type="text" placeholder="e.g., 90210, 10075" inputmode="numeric" />

    <label>Soft Proof (lived experience)</label>
    <input id="file" type="file" accept="image/*,application/pdf" />

    <div class="row" style="margin-top:14px;">
      <button id="geo">Use GPS</button>
      <button class="btn-ghost" id="hashBtn">Hash File Only</button>
    </div>

    <div class="ring" id="ring"><div class="dot" id="dot"></div></div>
    <small id="phaseText">Resonance window inactive.</small>

    <div class="row" style="margin-top:16px;">
      <button id="submit">Request Access</button>
      <button class="btn-ghost" id="buy">Buy Haus Key ($19)</button>
    </div>

    <label style="margin-top:18px;">Credential (CTDL JSON)</label>
    <pre id="out">{ /* waiting… */ }</pre>
    <small>Proof-of-receipt is hashed and time-stamped; matches your Mirror-Gain provenance practice.  [oai_citation:2‡AVC_Systems_Studios_Professional_Dossier_2025_Academic.pdf](sediment://file_000000002c0861f5836920639d413868)</small>
  </div>
</div>

<script>
const out = document.getElementById('out');
const ring = document.getElementById('ring');
const phaseText = document.getElementById('phaseText');
let gps = null;

// Minimal “resonance” doodle — rotate rings ~60s
let ang=0; setInterval(()=>{ ang=(ang+1)%360; ring.style.setProperty('--angle', ang+'deg'); }, 166);

// Soft resonance tease (fake until wired to Cycle Engine)
function setResonance(r){ 
  phaseText.textContent = r>=0.65 ? `High-clarity window active (R=${r.toFixed(2)})` : `Resonance ${r.toFixed(2)} — waiting…`;
  phaseText.className = r>=0.65 ? 'ok' : 'warn';
}
setResonance(Math.random()*0.5+0.4);

// client-side hash
async function sha256Hex(ab){
  const d = await crypto.subtle.digest("SHA-256", ab);
  const a = Array.from(new Uint8Array(d)); 
  return a.map(b=>b.toString(16).padStart(2,'0')).join('');
}

document.getElementById('geo').onclick = () => {
  navigator.geolocation?.getCurrentPosition(
    p => { gps = { lat:p.coords.latitude, lon:p.coords.longitude, acc:p.coords.accuracy }; alert('GPS captured.'); },
    _ => alert('GPS permission denied.'));
};

document.getElementById('hashBtn').onclick = async () => {
  const f = document.getElementById('file').files[0];
  if(!f){ alert('Attach a file first.'); return; }
  const buf = await f.arrayBuffer();
  const h = await sha256Hex(buf);
  out.textContent = JSON.stringify({ file_hash:`sha256:${h}`, name:f.name, size:f.size }, null, 2);
};

document.getElementById('buy').onclick = async () => {
  // Replace with Stripe/Ko-fi session creation:
  alert('Redirecting to checkout… (wire to Stripe/Ko-fi session URL)');
  // window.location = '/create-checkout-session';
};

document.getElementById('submit').onclick = async () => {
  const zip = (document.getElementById('zip').value||'').trim();
  const f = document.getElementById('file').files[0];

  let file_hash=null, file_meta=null;
  if(f){
    const buf = await f.arrayBuffer();
    file_hash = 'sha256:'+await sha256Hex(buf);
    file_meta = { name:f.name, size:f.size, type:f.type };
  }

  const payload = {
    user_id: "@avc",
    zip, verification_type: "soft_proof",
    gps, file_hash, file_meta,
    // optional market/context hooks for Cycle Engine later:
    context: { risk: 0.61, btc_sent: 2.8 }
  };

  const res = await fetch('/verify/submit', {
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
  });
  const json = await res.json();
  out.textContent = JSON.stringify(json, null, 2);
  setResonance(json.resonance ?? 0.72);
};
</script>
</body>
</html>
