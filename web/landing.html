<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Codex Revenue Pulse</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.0.6/css/pico.min.css"
      integrity="sha384-5gL/zy5tr3I9k2feuw+ZQilnxVe3Qo8NMHGUbqeasTyVmbwSPZ7T++YaUHr8r68m"
      crossorigin="anonymous"
    />
    <style>
      body {
        background: #0f172a;
        color: #f8fafc;
        display: flex;
        min-height: 100vh;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }
      .card {
        background: rgba(15, 23, 42, 0.8);
        border-radius: 24px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        padding: 2.5rem;
        max-width: 520px;
        width: 100%;
        box-shadow: 0 25px 65px rgba(15, 23, 42, 0.45);
      }
      .kpi-value {
        font-size: 2.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }
      .kpi-label {
        color: rgba(226, 232, 240, 0.75);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.85rem;
      }
      .engine-tags {
        margin-top: 2rem;
        display: grid;
        gap: 0.75rem;
      }
      .engine-tag-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(30, 41, 59, 0.65);
        padding: 0.75rem 1rem;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.25);
      }
      .powered-by {
        margin-top: 2rem;
        font-size: 0.9rem;
        color: rgba(148, 163, 184, 0.85);
        display: none;
      }
    </style>
  </head>
  <body>
    <main class="card">
      <header>
        <p class="kpi-label">Live Revenue</p>
        <div id="landingRevenue" class="kpi-value" aria-live="polite">Syncingâ€¦</div>
        <p id="landingUpdatedAt" class="kpi-label"></p>
      </header>
      <section>
        <p class="kpi-label">Top Engine Tags</p>
        <div id="engineTagList" class="engine-tags"></div>
      </section>
      <footer id="landingPoweredBy" class="powered-by">Powered by Google Cloud</footer>
    </main>
    <script>
      async function refreshCodexLanding() {
        const revenueEl = document.getElementById('landingRevenue');
        const updatedEl = document.getElementById('landingUpdatedAt');
        const engineListEl = document.getElementById('engineTagList');
        const poweredByEl = document.getElementById('landingPoweredBy');

        try {
          const response = await fetch('/api/codex');
          if (!response.ok) {
            throw new Error('Unable to reach codex endpoint');
          }

          const payload = await response.json();
          revenueEl.textContent = payload.live_revenue_display || 'Awaiting data';
          updatedEl.textContent = payload.generated_at
            ? `Updated ${new Date(payload.generated_at).toLocaleString()}`
            : '';

          engineListEl.innerHTML = '';
          if (Array.isArray(payload.engine_tag_summary) && payload.engine_tag_summary.length) {
            for (const item of payload.engine_tag_summary) {
              const div = document.createElement('div');
              div.className = 'engine-tag-item';
              div.innerHTML = `<span>${item.tag}</span><span>${item.count} deals</span>`;
              engineListEl.appendChild(div);
            }
          } else {
            const div = document.createElement('div');
            div.className = 'engine-tag-item';
            div.textContent = 'No telemetry yet';
            engineListEl.appendChild(div);
          }

          if (payload?.cloud?.credits_granted) {
            poweredByEl.style.display = 'block';
            poweredByEl.textContent = payload.cloud.message || 'Powered by Google Cloud';
          } else {
            poweredByEl.style.display = 'none';
          }
        } catch (error) {
          console.error('Failed to refresh codex landing metrics', error);
          revenueEl.textContent = 'Unavailable';
          updatedEl.textContent = '';
          engineListEl.innerHTML = '';
        }
      }

      refreshCodexLanding();
      setInterval(refreshCodexLanding, 60000);
    </script>
  </body>
</html>
