<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rebuttal: Interactive Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .bg-warm-bg {
        background-color: #fcfcf9;
      }
      .text-warm-text {
        color: #3d3a33;
      }
      .text-primary-700 {
        color: #0f766e;
      }
      .bg-primary-600 {
        background-color: #0d9488;
      }
      .hover\:bg-primary-700:hover {
        background-color: #0f766e;
      }
      .text-secondary-500 {
        color: #f59e0b;
      }
      .bg-secondary-500 {
        background-color: #f59e0b;
      }
      .hover\:bg-secondary-700:hover {
        background-color: #b45309;
      }
      .chart-container {
        position: relative;
        height: 100%;
        max-height: 400px;
      }
      @media (min-width: 768px) {
        .chart-container {
          max-height: 500px;
        }
      }
      .gemini-btn-spinner {
        display: none;
        animation: spin 1s linear infinite;
      }
      .gemini-btn.loading .gemini-btn-spinner {
        display: inline-block;
      }
      .gemini-btn.loading .gemini-btn-text {
        display: none;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "warm-bg": "#fcfcf9",
              "warm-text": "#3d3a33",
              primary: {
                600: "#0d9488",
                700: "#0f766e"
              },
              secondary: {
                500: "#f59e0b",
                700: "#b45309"
              }
            }
          }
        }
      };
    </script>
  </head>
  <body class="bg-warm-bg text-warm-text antialiased">
    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-sm shadow-md">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <a href="/index.html" class="flex-shrink-0 flex items-center">
            <span class="text-xl font-bold text-primary-700">Intuition Labs Rebuttal</span>
          </a>
          <nav class="hidden md:flex space-x-8">
            <a
              href="#engine"
              class="text-sm font-medium text-gray-700 hover:text-primary-700 transition-colors"
              >Pillar 1: Engine &amp; Proof</a
            >
            <a
              href="#logic"
              class="text-sm font-medium text-gray-700 hover:text-primary-700 transition-colors"
              >Pillar 2: Logic &amp; Intuition</a
            >
            <a
              href="#ecosystem"
              class="text-sm font-medium text-gray-700 hover:text-primary-700 transition-colors"
              >Pillar 3: Ecosystem &amp; Trust</a
            >
          </nav>
          <div class="md:hidden">
            <button
              id="mobile-menu-btn"
              type="button"
              class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-500"
            >
              <span class="sr-only">Open main menu</span>
              <div class="space-y-1.5">
                <span
                  id="burger-top"
                  class="block h-0.5 w-6 bg-primary-700 transition duration-300 ease-in-out"
                ></span>
                <span
                  id="burger-mid"
                  class="block h-0.5 w-6 bg-primary-700 transition duration-300 ease-in-out"
                ></span>
                <span
                  id="burger-bot"
                  class="block h-0.5 w-6 bg-primary-700 transition duration-300 ease-in-out"
                ></span>
              </div>
            </button>
          </div>
        </div>
      </div>
      <div id="mobile-menu" class="hidden md:hidden">
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 flex flex-col">
          <a
            href="#engine"
            class="text-base font-medium text-gray-700 hover:text-primary-700 hover:bg-gray-50 px-3 py-2 rounded-md transition-colors"
            >Pillar 1: Engine &amp; Proof</a
          >
          <a
            href="#logic"
            class="text-base font-medium text-gray-700 hover:text-primary-700 hover:bg-gray-50 px-3 py-2 rounded-md transition-colors"
            >Pillar 2: Logic &amp; Intuition</a
          >
          <a
            href="#ecosystem"
            class="text-base font-medium text-gray-700 hover:text-primary-700 hover:bg-gray-50 px-3 py-2 rounded-md transition-colors"
            >Pillar 3: Ecosystem &amp; Trust</a
          >
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="py-16 sm:py-20">
        <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-center text-warm-text tracking-tight">
          The Adaptive Ethics Rebuttal
        </h1>
        <p class="mt-6 text-xl text-gray-700 text-center max-w-3xl mx-auto">
          This is an interactive exploration of the rebuttal against critiques of the Intuition Labs
          system. We've transformed the six-part document into three dynamic pillars to demonstrate how
          our platform is data-validated, auditable, and community-governed.
        </p>
      </div>

      <section id="engine" class="py-16 sm:py-20 border-t border-gray-200">
        <h2 class="text-3xl sm:text-4xl font-bold text-primary-700 mb-4">Pillar 1: The Core Engine &amp; Proof</h2>

        <div id="engine-intro-container" class="flex items-center gap-4 mb-8 flex-col md:flex-row">
          <p class="text-lg text-gray-700 max-w-3xl">
            This section addresses the critique that our system lacks external proof. Here, we combine
            the claims from "Quantitative Proof" (Sec I) and the "Cunning Mercy Protocol" (Sec III) to
            show how statistical rigor and risk management are hard-coded into the engine's core.
            Interact with the snapshot below to see how data <em>directly</em> controls risk.
          </p>
          <button
            id="listen-engine-btn"
            class="gemini-btn flex-shrink-0 bg-secondary-500 text-white px-3 py-2 rounded-full font-medium shadow-md hover:bg-secondary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-secondary-500 focus:ring-opacity-50"
            title="Listen to intro"
          >
            <span class="gemini-btn-text">Listen ‚ú®</span>
            <span class="gemini-btn-spinner text-lg">&#8635;</span>
          </button>
        </div>

        <button
          id="summarize-engine-btn"
          class="gemini-btn mb-6 bg-primary-600 text-white px-4 py-2 rounded-lg font-medium shadow-md hover:bg-primary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50"
        >
          <span class="gemini-btn-text">‚ú® Summarize Pillar with Gemini</span>
          <span class="gemini-btn-spinner text-xl">&#8635;</span>
        </button>

        <div
          id="engine-summary-container"
          class="mb-12 p-4 rounded-lg bg-primary-600/10 text-warm-text hidden transition-all duration-300"
        >
          <h4 class="text-lg font-semibold text-primary-700 mb-2">‚ú® AI Summary</h4>
          <div id="engine-summary-content"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
          <div class="lg:col-span-1 bg-white rounded-xl shadow-xl overflow-hidden p-6 border border-gray-100">
            <h3 class="text-2xl font-semibold text-primary-700 mb-4 border-b pb-2">Risk/Proof Snapshot</h3>

            <div class="space-y-4">
              <div class="p-3 bg-gray-50 rounded-lg">
                <p class="text-sm font-medium text-gray-500">Current Tau Score (Correlation)</p>
                <p id="metric-tau" class="text-2xl font-bold text-warm-text">N/A</p>
              </div>
              <div class="p-3 bg-gray-50 rounded-lg">
                <p class="text-sm font-medium text-gray-500">P-Value (Significance)</p>
                <p id="metric-pvalue" class="text-2xl font-bold text-warm-text">N/A</p>
              </div>
              <div class="p-3 rounded-lg border-2" id="mercy-gate">
                <p class="text-sm font-medium text-gray-500">Cunning Mercy Gate (P &le; 0.05)</p>
                <p id="gate-3" class="text-xl font-bold text-red-500">CLOSED üö´</p>
              </div>
            </div>

            <div class="mt-6">
              <p class="text-sm font-medium text-gray-500 mb-2">Protocol Outcome</p>
              <div
                id="mercy-outcome"
                class="mt-2 p-4 rounded-lg bg-gray-100 text-center transition-all duration-300 border border-gray-200"
              >
                <p class="text-lg font-semibold text-warm-text">Status: Awaiting Simulation</p>
              </div>
            </div>

            <div class="mt-8 space-y-3">
              <button
                id="simulate-safe-btn"
                class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold shadow-md hover:bg-green-700 transition-colors"
              >
                Simulate: High-Confidence Data
              </button>
              <button
                id="simulate-risky-btn"
                class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold shadow-md hover:bg-red-700 transition-colors"
              >
                Simulate: Low-Confidence Data
              </button>
              <button
                id="simulate-reset-btn"
                class="w-full bg-gray-300 text-warm-text py-2 rounded-lg font-semibold shadow-md hover:bg-gray-400 transition-colors"
              >
                Reset
              </button>
            </div>

            <div class="mt-8">
              <h4 class="text-lg font-semibold text-primary-700 mb-2">Bring Your Own CSV Proof</h4>
              <p class="text-sm text-gray-600 mb-3">
                Upload a CSV with columns <code>date, signal, return</code> to compute Spearman's rho and
                drive the mercy gate using your real data.
              </p>
              <div class="flex flex-col gap-2">
                <input id="csvFile" type="file" accept=".csv" class="rounded border border-gray-300 px-3 py-2" />
                <button
                  id="analyzeBtn"
                  class="bg-primary-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-primary-700 transition-colors"
                >
                  Analyze CSV Proof
                </button>
              </div>
              <div id="statsOut" class="mt-3 text-sm text-gray-700"></div>
            </div>
          </div>

          <div class="lg:col-span-2 bg-white rounded-xl shadow-xl overflow-hidden p-6 border border-gray-100">
            <h3 class="text-2xl font-semibold text-primary-700 mb-4 border-b pb-2">Backtest Performance Chart</h3>
            <div class="chart-container">
              <canvas id="backtestChart"></canvas>
            </div>
            <p class="mt-4 text-sm text-gray-500">
              *This chart visually represents the strong correlation (Tau &gt; 0.6) between the engine's
              signal and market outcome over a simulated 180-day period using historical data, refuting
              claims of statistical irrelevance.
            </p>
          </div>
        </div>
      </section>

      <section id="logic" class="py-16 sm:py-20 border-t border-gray-200">
        <h2 class="text-3xl sm:text-4xl font-bold text-primary-700 mb-4">Pillar 2: Logic &amp; Intuition</h2>

        <div id="logic-intro-container" class="flex items-center gap-4 mb-8 flex-col md:flex-row">
          <p class="text-lg text-gray-700 max-w-3xl">
            This pillar refutes the "N=1" (founder-dependent) and "black box" critiques. It combines
            "Beyond N=1" (Sec II) and "Dual-Layer Design" (Sec IV) to show how kinesthetic intuition is
            translated into scalable, auditable code. Explore the "translation" from poetic terms to the
            logic layer below.
          </p>
          <button
            id="listen-logic-btn"
            class="gemini-btn flex-shrink-0 bg-secondary-500 text-white px-3 py-2 rounded-full font-medium shadow-md hover:bg-secondary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-secondary-500 focus:ring-opacity-50"
            title="Listen to intro"
          >
            <span class="gemini-btn-text">Listen ‚ú®</span>
            <span class="gemini-btn-spinner text-lg">&#8635;</span>
          </button>
        </div>

        <button
          id="summarize-logic-btn"
          class="gemini-btn mb-6 bg-primary-600 text-white px-4 py-2 rounded-lg font-medium shadow-md hover:bg-primary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50"
        >
          <span class="gemini-btn-text">‚ú® Summarize Pillar with Gemini</span>
          <span class="gemini-btn-spinner text-xl">&#8635;</span>
        </button>

        <div
          id="logic-summary-container"
          class="mb-12 p-4 rounded-lg bg-primary-600/10 text-warm-text hidden transition-all duration-300"
        >
          <h4 class="text-lg font-semibold text-primary-700 mb-2">‚ú® AI Summary</h4>
          <div id="logic-summary-content"></div>
        </div>

        <div class="bg-white rounded-xl shadow-xl overflow-hidden p-6 border border-gray-100 mb-12">
          <h3 class="text-2xl font-semibold text-primary-700 mb-4 border-b pb-2">Dual-Layer FSM (Finite State Machine)</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
              <p class="text-sm font-medium text-gray-500">Kinesthetic Layer (Poetic State)</p>
              <p id="fsm-poetic" class="text-xl font-bold text-warm-text mt-1">Stasis (Neutral)</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
              <p class="text-sm font-medium text-gray-500">Logic Layer (FSM State)</p>
              <p id="fsm-logic" class="text-xl font-bold text-warm-text mt-1">STATE_IDLE</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
              <p class="text-sm font-medium text-gray-500">Next Signal/Cue</p>
              <p id="fsm-signal" class="text-xl font-bold text-warm-text mt-1">CUE: None</p>
            </div>
          </div>

          <div class="mt-6 flex flex-wrap gap-3 justify-center">
            <button
              data-state="Coda"
              class="fsm-btn bg-green-500 text-white px-4 py-2 rounded-full font-medium shadow-md hover:bg-green-600 transition-colors"
            >
              Coda (Profit)
            </button>
            <button
              data-state="Lull"
              class="fsm-btn bg-blue-500 text-white px-4 py-2 rounded-full font-medium shadow-md hover:bg-blue-600 transition-colors"
            >
              Lull (Wait)
            </button>
            <button
              data-state="Amnesty"
              class="fsm-btn bg-yellow-500 text-gray-800 px-4 py-2 rounded-full font-medium shadow-md hover:bg-yellow-600 transition-colors"
            >
              Amnesty (Risk Off)
            </button>
            <button
              data-state="Flint"
              class="fsm-btn bg-red-500 text-white px-4 py-2 rounded-full font-medium shadow-md hover:bg-red-600 transition-colors"
            >
              Flint (Risk On)
            </button>
          </div>

          <div class="mt-8 p-4 bg-gray-100 rounded-lg border border-gray-200">
            <p class="text-sm font-medium text-gray-500 mb-2">FSM Output Log</p>
            <pre id="fsm-output-log" class="text-sm text-warm-text whitespace-pre-wrap font-mono"></pre>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-xl overflow-hidden p-6 border border-gray-100">
          <h3 class="text-2xl font-semibold text-primary-700 mb-4 border-b pb-2">Auditable Logic Mapping</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead>
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Kinesthetic Term
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Logic Layer Translation
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Audit Condition
                  </th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                <tr class="bg-gray-50">
                  <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-warm-text">Stasis</td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">STATE_IDLE</td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">
                    <code>time_in_state &gt; 30s</code> AND <code>momentum_idx = 0</code>
                  </td>
                </tr>
                <tr>
                  <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-warm-text">Flint (Risk On)</td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">STATE_ENTRY</td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">
                    <code>sentiment_score &lt; -0.8</code> AND <code>volume_spike &gt; 2x</code>
                  </td>
                </tr>
                <tr class="bg-gray-50">
                  <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-warm-text">Amnesty (Risk Off)</td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">STATE_EXIT</td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">
                    <code>mercy_gate = CLOSED</code> OR <code>vix_delta &gt; 1.5</code>
                  </td>
                </tr>
                <tr>
                  <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-warm-text">Coda (Profit)</td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">STATE_EXIT</td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">
                    <code>target_angle_45_hit = true</code>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="ecosystem" class="py-16 sm:py-20 border-t border-gray-200">
        <h2 class="text-3xl sm:text-4xl font-bold text-primary-700 mb-4">Pillar 3: Ecosystem &amp; Trust</h2>

        <div id="ecosystem-intro-container" class="flex items-center gap-4 mb-8 flex-col md:flex-row">
          <p class="text-lg text-gray-700 max-w-3xl">
            This final pillar addresses the system's future, combining the "Roadmap" (Sec V) and
            "Institutionalization" (Sec VI). We are building an open, auditable ecosystem, not a personal
            project. Our governance is built on verifiable reputation ("Sentient Cents"), not speculation,
            ensuring the founder's vision is institutionalized.
          </p>
          <button
            id="listen-ecosystem-btn"
            class="gemini-btn flex-shrink-0 bg-secondary-500 text-white px-3 py-2 rounded-full font-medium shadow-md hover:bg-secondary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-secondary-500 focus:ring-opacity-50"
            title="Listen to intro"
          >
            <span class="gemini-btn-text">Listen ‚ú®</span>
            <span class="gemini-btn-spinner text-lg">&#8635;</span>
          </button>
        </div>

        <button
          id="summarize-ecosystem-btn"
          class="gemini-btn mb-6 bg-primary-600 text-white px-4 py-2 rounded-lg font-medium shadow-md hover:bg-primary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50"
        >
          <span class="gemini-btn-text">‚ú® Summarize Pillar with Gemini</span>
          <span class="gemini-btn-spinner text-xl">&#8635;</span>
        </button>

        <div
          id="ecosystem-summary-container"
          class="mb-12 p-4 rounded-lg bg-primary-600/10 text-warm-text hidden transition-all duration-300"
        >
          <h4 class="text-lg font-semibold text-primary-700 mb-2">‚ú® AI Summary</h4>
          <div id="ecosystem-summary-content"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-stretch">
          <div class="bg-white rounded-xl shadow-xl overflow-hidden p-6 border border-gray-100">
            <h3 class="text-2xl font-semibold text-primary-700 mb-4 border-b pb-2">Decentralized Governance Roadmap</h3>
            <ul class="space-y-4 list-disc list-inside text-gray-700">
              <li class="pl-2">
                <span class="font-semibold text-warm-text">Phase 1 (Q4/24):</span> Core Protocol Open-Sourcing. Move all non-proprietary logic to public repositories for community auditing.
              </li>
              <li class="pl-2">
                <span class="font-semibold text-warm-text">Phase 2 (Q1/25):</span> Introduction of Sentient Cents (SC). Reputation-based, non-transferable soulbound tokens (SBTs) granted based on validated contributions.
              </li>
              <li class="pl-2">
                <span class="font-semibold text-warm-text">Phase 3 (Q2/25):</span> Decentralized Autonomous Organization (DAO) Formation. Governance weighted by SC stake, ensuring decision-making power rests with proven contributors.
              </li>
              <li class="pl-2">
                <span class="font-semibold text-warm-text">Phase 4 (Q3/25):</span> Adaptive Protocol Veto. Community-led votes on protocol changes, requiring 75% SC consensus.
              </li>
            </ul>
          </div>

          <div class="bg-white rounded-xl shadow-xl overflow-hidden p-6 border border-gray-100">
            <h3 class="text-2xl font-semibold text-primary-700 mb-4 border-b pb-2">Ecosystem Architecture</h3>
            <div class="flex flex-col items-center justify-center space-y-4 h-full min-h-[300px]">
              <div class="p-4 bg-primary-600 text-white rounded-full shadow-lg font-bold">
                Adaptive Ethics Foundation üõ°Ô∏è
              </div>
              <div class="text-xl text-primary-700">|</div>
              <div class="flex flex-col sm:flex-row sm:space-x-8 space-y-4 sm:space-y-0">
                <div class="flex flex-col items-center p-4 bg-gray-100 rounded-xl shadow-md border border-gray-200">
                  <span class="text-3xl mb-2">üë•</span>
                  <span class="font-medium text-warm-text">DAO &amp; Community</span>
                  <span class="text-xs text-gray-500">Governance &amp; Auditing</span>
                </div>
                <div class="flex flex-col items-center p-4 bg-gray-100 rounded-xl shadow-md border border-gray-200">
                  <span class="text-3xl mb-2">üéñÔ∏è</span>
                  <span class="font-medium text-warm-text">Sentient Cents (SC)</span>
                  <span class="text-xs text-gray-500">Reputation &amp; Stake</span>
                </div>
              </div>
              <div class="text-xl text-primary-700">|</div>
              <div class="p-3 bg-secondary-500 text-white rounded-lg shadow-lg font-bold">
                Intuition Labs Protocol Core
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="py-16 sm:py-20 border-t border-gray-200">
        <h2 class="text-3xl sm:text-4xl font-bold text-center text-primary-700 mb-4">Conclusion</h2>
        <p class="mt-6 text-lg text-gray-700 max-w-4xl mx-auto text-center">
          The critique that Intuition Labs is a "black box" dependent on a single founder is demonstrably
          false. Our system is quantitatively proven via statistical correlation, auditable through our
          Dual-Layer FSM, and engineered for institutionalization under a merit-based, decentralized
          governance model. The next steps involve transitioning to a fully open-source and SC-governed
          structure.
        </p>
      </section>
    </main>

    <footer class="bg-white border-t border-gray-200 mt-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center">
        <p class="text-sm text-gray-500">&copy; 2025 Adaptive Ethics Foundation &amp; Intuition Labs. All rights reserved.</p>
      </div>
    </footer>

    <audio id="tts-player" class="hidden"></audio>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const SUMMARY_ENDPOINT = "/api/rebuttal/summary";
        const TTS_ENDPOINT = "/api/rebuttal/tts";
        const geminiSystemPrompt =
          "You are an expert analyst. Summarize the following information from a technical rebuttal into a concise HTML list with 3 bullet points (<ul><li>...</li></ul>). Focus on the core claims, evidence, and strategic implications. Do not include any introductory or concluding sentences outside the list.";

        const audioPlayer = document.getElementById("tts-player");
        let currentPlayingBtn = null;

        const ttsButtons = [
          { id: "listen-engine-btn", textId: "engine-intro-container" },
          { id: "listen-logic-btn", textId: "logic-intro-container" },
          { id: "listen-ecosystem-btn", textId: "ecosystem-intro-container" }
        ];

        const summaryButtons = [
          {
            id: "summarize-engine-btn",
            sectionId: "engine",
            contentId: "engine-summary-content",
            containerId: "engine-summary-container"
          },
          {
            id: "summarize-logic-btn",
            sectionId: "logic",
            contentId: "logic-summary-content",
            containerId: "logic-summary-container"
          },
          {
            id: "summarize-ecosystem-btn",
            sectionId: "ecosystem",
            contentId: "ecosystem-summary-content",
            containerId: "ecosystem-summary-container"
          }
        ];

        async function callGeminiSummary(sectionText, systemPrompt, retries = 2, delay = 1200) {
          for (let attempt = 0; attempt <= retries; attempt += 1) {
            try {
              const response = await fetch(SUMMARY_ENDPOINT, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ sectionText, systemPrompt })
              });
              const data = await response.json();
              if (!response.ok) {
                throw new Error(data?.error || `HTTP ${response.status}`);
              }
              return data?.html ?? "";
            } catch (error) {
              if (attempt === retries) {
                console.error("Gemini summary error", error);
                return `<p class="text-red-600">Error: Could not generate summary. Please try again. (${error.message})</p>`;
              }
              await new Promise((resolve) => setTimeout(resolve, delay * (attempt + 1)));
            }
          }
          return "";
        }

        async function callGeminiTTS(textToSpeak, voiceName = "Charon", retries = 2, delay = 1200) {
          for (let attempt = 0; attempt <= retries; attempt += 1) {
            try {
              const response = await fetch(TTS_ENDPOINT, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: textToSpeak, voiceName })
              });
              const data = await response.json();
              if (!response.ok) {
                throw new Error(data?.error || `HTTP ${response.status}`);
              }
              return data;
            } catch (error) {
              if (attempt === retries) {
                console.error("Gemini TTS error", error);
                return null;
              }
              await new Promise((resolve) => setTimeout(resolve, delay * (attempt + 1)));
            }
          }
          return null;
        }

        function base64ToUint8Array(base64) {
          const binaryString = window.atob(base64);
          const len = binaryString.length;
          const bytes = new Uint8Array(len);
          for (let i = 0; i < len; i += 1) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          return bytes;
        }

        function pcmBytesToWav(bytes, sampleRate) {
          const numChannels = 1;
          const bitsPerSample = 16;
          const blockAlign = (numChannels * bitsPerSample) / 8;
          const byteRate = sampleRate * blockAlign;
          const dataSize = bytes.length;
          const buffer = new ArrayBuffer(44 + dataSize);
          const view = new DataView(buffer);

          view.setUint32(0, 0x52494646, false);
          view.setUint32(4, 36 + dataSize, true);
          view.setUint32(8, 0x57415645, false);
          view.setUint32(12, 0x666d7420, false);
          view.setUint32(16, 16, true);
          view.setUint16(20, 1, true);
          view.setUint16(22, numChannels, true);
          view.setUint32(24, sampleRate, true);
          view.setUint32(28, byteRate, true);
          view.setUint16(32, blockAlign, true);
          view.setUint16(34, bitsPerSample, true);
          view.setUint32(36, 0x64617461, false);
          view.setUint32(40, dataSize, true);

          for (let i = 0; i < bytes.length; i += 1) {
            view.setUint8(44 + i, bytes[i]);
          }

          return new Blob([buffer], { type: "audio/wav" });
        }

        async function playAudioData(apiResponse, btn) {
          if (!apiResponse) {
            alert("Error generating audio.");
            resetTtsButton(btn);
            return;
          }

          try {
            const sampleRateMatch = /rate=(\d+)/.exec(apiResponse.mimeType ?? "");
            const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
            const pcmBytes = base64ToUint8Array(apiResponse.audioData);
            const wavBlob = pcmBytesToWav(pcmBytes, sampleRate);
            const audioUrl = URL.createObjectURL(wavBlob);

            audioPlayer.src = audioUrl;
            await audioPlayer.play();
            btn.querySelector(".gemini-btn-text").textContent = "Playing...";
            currentPlayingBtn = btn;

            audioPlayer.onended = () => {
              resetTtsButton(currentPlayingBtn);
              currentPlayingBtn = null;
              URL.revokeObjectURL(audioUrl);
            };
          } catch (error) {
            console.error("Error processing audio", error);
            alert("Error playing audio.");
            resetTtsButton(btn);
          }
        }

        function resetTtsButton(btn) {
          if (btn) {
            btn.classList.remove("loading");
            btn.querySelector(".gemini-btn-text").textContent = "Listen ‚ú®";
            btn.disabled = false;
          }
        }

        ttsButtons.forEach((item) => {
          const btn = document.getElementById(item.id);
          if (!btn) return;

          btn.addEventListener("click", async () => {
            if (currentPlayingBtn) {
              audioPlayer.pause();
              audioPlayer.currentTime = 0;
              resetTtsButton(currentPlayingBtn);
              if (currentPlayingBtn === btn) {
                currentPlayingBtn = null;
                return;
              }
            }

            try {
              await audioPlayer.play();
            } catch (err) {
              console.debug("Audio priming", err);
            }
            audioPlayer.pause();
            audioPlayer.currentTime = 0;

            btn.classList.add("loading");
            btn.disabled = true;

            const textContainer = document.getElementById(item.textId);
            const paragraph = textContainer?.querySelector("p");
            const textToSpeak = paragraph?.textContent?.trim();
            if (!textToSpeak) {
              alert("Error: Could not find text to speak.");
              resetTtsButton(btn);
              return;
            }

            const audioData = await callGeminiTTS(textToSpeak);
            await playAudioData(audioData, btn);
          });
        });

        summaryButtons.forEach((item) => {
          const btn = document.getElementById(item.id);
          if (!btn) return;

          btn.addEventListener("click", async () => {
            btn.classList.add("loading");
            btn.disabled = true;

            const section = document.getElementById(item.sectionId);
            const contentContainer = document.getElementById(item.contentId);
            const summaryContainer = document.getElementById(item.containerId);
            const sectionText = section?.textContent?.trim() ?? "";

            const summaryHtml = sectionText
              ? await callGeminiSummary(sectionText, geminiSystemPrompt)
              : "<p class=\"text-red-600\">Error: Unable to read section content.</p>";

            if (contentContainer) {
              contentContainer.innerHTML = summaryHtml;
            }
            summaryContainer?.classList.remove("hidden");

            btn.classList.remove("loading");
            btn.disabled = false;
          });
        });

        const initialState = {
          tauScore: "N/A",
          pValue: "N/A",
          mercyGateOpen: false,
          outcome: "Status: Awaiting Simulation",
          outcomeClass: "bg-gray-100",
          pValueNum: null
        };

        const safeState = {
          tauScore: "0.71",
          pValue: "0.021",
          mercyGateOpen: true,
          outcome: "Gate OPEN. Protocol is active, risk accepted.",
          outcomeClass: "bg-green-100",
          pValueNum: 0.021
        };

        const riskyState = {
          tauScore: "0.33",
          pValue: "0.330",
          mercyGateOpen: false,
          outcome: "Gate CLOSED. Protocol stopped, risk denied.",
          outcomeClass: "bg-red-100",
          pValueNum: 0.33
        };

        let currentState = { ...initialState };

        const metricTau = document.getElementById("metric-tau");
        const metricPValue = document.getElementById("metric-pvalue");
        const mercyGate = document.getElementById("mercy-gate");
        const gate3 = document.getElementById("gate-3");
        const mercyOutcome = document.getElementById("mercy-outcome");

        const simulateSafeBtn = document.getElementById("simulate-safe-btn");
        const simulateRiskyBtn = document.getElementById("simulate-risky-btn");
        const simulateResetBtn = document.getElementById("simulate-reset-btn");

        function updateDisplay() {
          if (metricTau) metricTau.textContent = currentState.tauScore;
          if (metricPValue) metricPValue.textContent = currentState.pValue;
          if (gate3) {
            gate3.textContent = currentState.mercyGateOpen ? "OPEN ‚úÖ" : "CLOSED üö´";
            gate3.classList.toggle("text-green-500", currentState.mercyGateOpen);
            gate3.classList.toggle(
              "text-red-500",
              !currentState.mercyGateOpen && currentState.pValueNum !== null
            );
          }
          if (mercyGate) {
            mercyGate.classList.toggle("border-green-500", currentState.mercyGateOpen);
            mercyGate.classList.toggle(
              "border-red-500",
              !currentState.mercyGateOpen && currentState.pValueNum !== null
            );
          }
          if (mercyOutcome) {
            mercyOutcome.textContent = currentState.outcome;
            mercyOutcome.className =
              "mt-6 p-4 rounded-lg text-center transition-all duration-300 border " +
              (currentState.mercyGateOpen
                ? "bg-green-50 border-green-200"
                : currentState.pValueNum !== null
                ? "bg-red-50 border-red-200"
                : "bg-gray-100 border-gray-200");
          }
        }

        simulateSafeBtn?.addEventListener("click", () => {
          currentState = { ...safeState };
          updateDisplay();
        });

        simulateRiskyBtn?.addEventListener("click", () => {
          currentState = { ...riskyState };
          updateDisplay();
        });

        simulateResetBtn?.addEventListener("click", () => {
          currentState = { ...initialState };
          updateDisplay();
        });

        const csvFileInput = document.getElementById("csvFile");
        const analyzeBtn = document.getElementById("analyzeBtn");
        const statsOut = document.getElementById("statsOut");

        function rankWithTies(values) {
          const pairs = values
            .map((value, index) => ({ value, index }))
            .sort((a, b) => a.value - b.value);

          const ranks = new Array(values.length);
          let i = 0;
          while (i < pairs.length) {
            let j = i;
            while (j + 1 < pairs.length && pairs[j + 1].value === pairs[i].value) {
              j += 1;
            }
            const avgRank = (i + j + 2) / 2; // convert to 1-based rank
            for (let k = i; k <= j; k += 1) {
              ranks[pairs[k].index] = avgRank;
            }
            i = j + 1;
          }
          return ranks;
        }

        function spearmanRho(x, y) {
          if (x.length !== y.length || x.length === 0) return NaN;
          const rx = rankWithTies(x);
          const ry = rankWithTies(y);
          let num = 0;
          let denX = 0;
          let denY = 0;
          const meanX = rx.reduce((acc, val) => acc + val, 0) / rx.length;
          const meanY = ry.reduce((acc, val) => acc + val, 0) / ry.length;
          for (let i = 0; i < rx.length; i += 1) {
            const dx = rx[i] - meanX;
            const dy = ry[i] - meanY;
            num += dx * dy;
            denX += dx * dx;
            denY += dy * dy;
          }
          const denominator = Math.sqrt(denX * denY);
          return denominator === 0 ? NaN : num / denominator;
        }

        function erf(x) {
          const sign = Math.sign(x);
          const absX = Math.abs(x);
          const a1 = 0.254829592;
          const a2 = -0.284496736;
          const a3 = 1.421413741;
          const a4 = -1.453152027;
          const a5 = 1.061405429;
          const p = 0.3275911;
          const t = 1 / (1 + p * absX);
          const y =
            1 -
            (((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t * Math.exp(-absX * absX));
          return sign * y;
        }

        function pValueSpearman(rho, n) {
          if (!Number.isFinite(rho) || n < 3 || Math.abs(rho) >= 1) {
            return NaN;
          }
          const t = rho * Math.sqrt((n - 2) / Math.max(1e-12, 1 - rho * rho));
          const z = Math.abs(t) / Math.SQRT2;
          const pOne = 0.5 * (1 - erf(z));
          return Math.min(1, Math.max(0, 2 * pOne));
        }

        analyzeBtn?.addEventListener("click", async () => {
          if (!csvFileInput?.files?.length) {
            alert("Select a CSV file with columns: date, signal, return.");
            return;
          }
          const file = csvFileInput.files[0];
          let text;
          try {
            text = await file.text();
          } catch (error) {
            alert("Unable to read CSV file.");
            console.error(error);
            return;
          }
          const rows = text.trim().split(/\r?\n/);
          if (rows.length <= 1) {
            statsOut.textContent = "CSV contains no data rows.";
            return;
          }
          const headers = rows[0].split(",").map((h) => h.trim().toLowerCase());
          const signalIdx = headers.indexOf("signal");
          const returnIdx = headers.indexOf("return");
          if (signalIdx === -1 || returnIdx === -1) {
            statsOut.textContent = "Missing required columns: signal and return.";
            return;
          }
          const signals = [];
          const returns = [];
          for (let i = 1; i < rows.length; i += 1) {
            const cols = rows[i].split(",");
            if (cols.length <= Math.max(signalIdx, returnIdx)) continue;
            const s = Number.parseFloat(cols[signalIdx]);
            const r = Number.parseFloat(cols[returnIdx]);
            if (Number.isFinite(s) && Number.isFinite(r)) {
              signals.push(s);
              returns.push(r);
            }
          }
          if (signals.length < 10) {
            statsOut.textContent = "Need at least 10 numeric rows to compute Spearman's rho.";
            currentState = { ...initialState };
            updateDisplay();
            return;
          }
          const rho = spearmanRho(signals, returns);
          const p = pValueSpearman(rho, signals.length);
          if (!Number.isFinite(rho) || !Number.isFinite(p)) {
            statsOut.textContent = "Unable to compute metrics from the provided data.";
            currentState = { ...initialState };
            updateDisplay();
            return;
          }
          const gateOpen = p <= 0.05;
          statsOut.textContent = `n=${signals.length}, Spearman rho=${rho.toFixed(3)}, approx p=${p.toExponential(
            2
          )}`;
          currentState = {
            tauScore: rho.toFixed(2),
            pValue: p.toFixed(3),
            pValueNum: p,
            mercyGateOpen: gateOpen,
            outcome: gateOpen
              ? "Gate OPEN. Protocol is active, risk accepted."
              : "Gate CLOSED. Protocol stopped, risk denied.",
            outcomeClass: gateOpen ? "bg-green-100" : "bg-red-100"
          };
          updateDisplay();
        });

        const fsmBtns = document.querySelectorAll(".fsm-btn");
        const fsmPoetic = document.getElementById("fsm-poetic");
        const fsmLogic = document.getElementById("fsm-logic");
        const fsmSignal = document.getElementById("fsm-signal");
        const fsmOutputLog = document.getElementById("fsm-output-log");

        const fsmData = {
          Stasis: { logic: "STATE_IDLE", signal: "CUE: None", log: "[10:00] FSM: Initialized to STATE_IDLE." },
          Coda: {
            logic: "STATE_EXIT",
            signal: "CUE: Coda (Profit)",
            log: "[10:15] CUE: Coda (Profit) | Target Angle45 hit. Exiting position with profit."
          },
          Lull: {
            logic: "STATE_WAIT",
            signal: "CUE: Lull (Wait)",
            log: "[10:05] CUE: Lull (Wait) | Volatility dropped below threshold. Entering STATE_WAIT."
          },
          Amnesty: {
            logic: "STATE_EXIT",
            signal: "CUE: Amnesty (Risk Off)",
            log: "[10:20] CUE: Amnesty (Risk Off) | Mercy Gate CLOSED. Immediate risk denial initiated."
          },
          Flint: {
            logic: "STATE_ENTRY",
            signal: "CUE: Flint (Risk On)",
            log: "[10:10] CUE: Flint (Risk On) | Sentiment score -0.9, volume spike confirmed. Entering position."
          }
        };

        fsmBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            const stateName = btn.getAttribute("data-state");
            const data = stateName ? fsmData[stateName] : undefined;
            if (data) {
              const poeticDescriptor = data.signal.replace(/^CUE:\s*/i, "");
              fsmPoetic.textContent = `${stateName} (${poeticDescriptor})`;
              fsmLogic.textContent = data.logic;
              fsmSignal.textContent = data.signal;
              fsmOutputLog.textContent = data.log;
            }
          });
        });

        const backtestCtx = document.getElementById("backtestChart")?.getContext("2d");
        if (backtestCtx) {
          new Chart(backtestCtx, {
            type: "line",
            data: {
              labels: Array.from({ length: 180 }, (_, i) => `Day ${i + 1}`),
              datasets: [
                {
                  label: "Engine Signal Strength (Normalized)",
                  data: Array.from({ length: 180 }, (_, i) => Math.sin(i / 10) * 0.4 + Math.random() * 0.2 + 0.4),
                  borderColor: "#0d9488",
                  tension: 0.4,
                  fill: false,
                  yAxisID: "y"
                },
                {
                  label: "Market Outcome (Cumulative %)",
                  data: Array.from({ length: 180 }, (_, i) => (i / 180) * 10 + Math.random() * 3 - 1.5),
                  borderColor: "#f59e0b",
                  tension: 0.4,
                  fill: false,
                  yAxisID: "y1"
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  type: "linear",
                  display: true,
                  position: "left",
                  title: {
                    display: true,
                    text: "Signal Strength (0-1)"
                  },
                  min: 0,
                  max: 1
                },
                y1: {
                  type: "linear",
                  display: true,
                  position: "right",
                  title: {
                    display: true,
                    text: "Market Outcome (%)"
                  },
                  grid: {
                    drawOnChartArea: false
                  }
                }
              }
            }
          });
        }

        const mobileMenuBtn = document.getElementById("mobile-menu-btn");
        const mobileMenu = document.getElementById("mobile-menu");
        const burgerTop = document.getElementById("burger-top");
        const burgerMid = document.getElementById("burger-mid");
        const burgerBot = document.getElementById("burger-bot");

        mobileMenuBtn?.addEventListener("click", () => {
          mobileMenu?.classList.toggle("hidden");
          burgerTop?.classList.toggle("rotate-45");
          burgerTop?.classList.toggle("translate-y-2");
          burgerMid?.classList.toggle("opacity-0");
          burgerBot?.classList.toggle("-translate-y-2");
          burgerBot?.classList.toggle("-rotate-45");
        });

        document.querySelectorAll("#mobile-menu a").forEach((link) => {
          link.addEventListener("click", () => {
            mobileMenu?.classList.add("hidden");
            burgerTop?.classList.remove("rotate-45", "translate-y-2");
            burgerMid?.classList.remove("opacity-0");
            burgerBot?.classList.remove("-translate-y-2", "-rotate-45");
          });
        });

        document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
          anchor.addEventListener("click", (e) => {
            e.preventDefault();
            const target = document.querySelector(anchor.getAttribute("href"));
            target?.scrollIntoView({ behavior: "smooth" });
          });
        });

        updateDisplay();
      });
    </script>
  </body>
</html>
