name: Create Spark
on:
  workflow_dispatch:
    inputs:
      spark_name:
        description: "Name (slug) for the new spark (lowercase letters, numbers and dash)"
        required: true

jobs:
  create_spark:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Create spark directory and update index
        run: |
          set -euo pipefail
          SPARK="${{ github.event.inputs.spark_name }}"
          if [ -z "$SPARK" ]; then echo "spark_name required"; exit 1; fi
          DEST="sparks/$SPARK"
          if [ -d "$DEST" ]; then echo "$DEST already exists"; exit 1; fi
          mkdir -p "$DEST"
          cp -R spark-template/* "$DEST/"
          # replace placeholder token in text files
          find "$DEST" -type f -exec sed -i "s/__SPARK_NAME__/${SPARK}/g" {} +
          # update index.json
          node -e "const fs=require('fs');const p='sparks/index.json';const arr=fs.existsSync(p)?JSON.parse(fs.readFileSync(p)):[];arr.unshift(process.argv[1]);fs.writeFileSync(p,JSON.stringify(Array.from(new Set(arr)),null,2));" "$SPARK"

      - name: Commit and push new spark
        env:
          GIT_COMMITTER_NAME: "github-actions[bot]"
          GIT_COMMITTER_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
        run: |
          git config user.name "${GIT_COMMITTER_NAME}"
          git config user.email "${GIT_COMMITTER_EMAIL}"
          git add sparks
          git commit -m "Create spark: $SPARK"
          # push to same branch the workflow ran on
          BRANCH="${GITHUB_REF#refs/heads/}"
          git push origin HEAD:"$BRANCH"
